# Oasis 目标检测系统 - PyQt6 图形界面

## 概述

Oasis 是一个基于 Kinect 2.0 和 YOLO 深度学习模型的实时目标检测系统，现已配备现代化的 PyQt6 图形用户界面。

## 主要功能

- 🎯 **实时目标检测**: 使用 YOLO11n 模型进行高效检测
- 📷 **Kinect 2.0 集成**: 支持深度相机实时视频流
- 🐛 **调试模式**: 支持电脑摄像头进行目标检测（无需 Kinect）
- 📐 **3D坐标获取**: 获取检测目标的空间三维坐标（毫米精度）
- 🏷️ **自定义类别**: 用户可自行添加需要检测的物体类型
- 🎨 **现代化界面**: 基于 PyQt6 的美观用户界面
- ⚙️ **灵活配置**: 可自定义检测类别、置信度等参数
- 📊 **实时统计**: 显示检测结果和性能指标

## 快速开始

### 1. 环境要求

- Python 3.8+
- Kinect for Windows SDK 2.0
- USB 3.0 端口（用于 Kinect 2.0）

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 运行图形界面

```bash
# 推荐：安全启动器（自动处理兼容性问题）
python main_ui_safe.py

# 或者：标准启动器
python main_ui.py

# 或者：UI文件版本启动器
python main_ui_loader.py
```

## 界面功能

### 主窗口组件

1. **视频显示区域**: 实时显示视频流和检测结果
2. **控制面板**: 
   - **检测模式选择**: Kinect 2.0 模式 / 调试模式 (电脑摄像头)
   - **Kinect 视频流选择**: Kinect 模式下可选择视频流类型
   - **摄像头选择**: 调试模式下可选择不同摄像头
   - **开始/停止检测按钮**
   - **目标类别选择器**
   - **3D坐标功能**: 可启用/禁用3D坐标计算
   - **自定义检测类别**: 用户可添加和管理自定义物体类型
3. **检测结果面板**: 显示当前检测到的对象列表
4. **菜单栏**: 
   - 文件 → 设置：打开配置对话框
   - 视图 → 重置布局：恢复默认界面布局
   - 帮助 → 关于：查看版本信息

### 检测模式说明

#### Kinect 2.0 模式
- 使用 Kinect 2.0 深度相机进行检测
- 需要安装 Kinect for Windows SDK 2.0
- 支持多种视频流类型：
  - **彩色图像 (RGB)**: 标准彩色视频，支持目标检测
  - **深度图像**: 距离信息可视化，灰度显示
  - **红外图像**: 红外光谱图像，灰度显示  
  - **人体索引图像**: 人体分割可视化，彩色标识不同人体

#### 调试模式 (电脑摄像头)
- 使用电脑内置或外接摄像头进行检测
- 无需 Kinect 设备，便于开发和测试
- 支持多摄像头选择 (摄像头 0, 1, 2)
- 基于 `main.py` 的功能集成

### 3D坐标功能

#### 功能说明
- 自动计算检测目标在3D空间中的坐标位置
- 坐标单位：毫米 (mm)
- 基于 Kinect 2.0 的深度信息和彩色图像融合
- 实时显示目标的 X、Y、Z 坐标

#### 使用要求
- 仅在 **Kinect 2.0 模式** 下可用
- 需要选择 **彩色图像 (RGB)** 视频流
- 确保 Kinect 深度传感器正常工作

#### 坐标系说明
- **X轴**: 水平方向（左负右正）
- **Y轴**: 垂直方向（上负下正）
- **Z轴**: 深度方向（距离传感器的直线距离）

### 自定义检测类别

#### 功能说明
- 用户可添加 YOLO 模型支持但不在预设列表中的物体类型
- 实时添加和删除自定义类别
- 自定义类别与预设类别统一管理

#### 使用方法
1. 在 "自定义检测类别" 面板输入类别名称
2. 点击 "添加" 按钮
3. 类别将出现在列表中并自动参与检测
4. 选中不需要的类别，点击 "删除选中项" 移除

### 设置对话框

#### 检测设置
- **模型文件**: 选择 YOLO 模型文件
- **置信度阈值**: 调整检测敏感度 (0.01-1.00)
- **最大检测数**: 限制同时检测的对象数量
- **目标类别**: 选择要检测的对象类型

#### 显示设置
- **显示选项**: 控制是否显示置信度和类别名称
- **边框样式**: 调整边界框粗细
- **字体大小**: 设置标签文字大小
- **颜色配置**: 自定义边框和文字颜色

#### Kinect 设置
- **分辨率**: 选择彩色图像分辨率
- **帧率**: 设置视频帧率
- **自动曝光**: 启用/禁用自动曝光控制

## 文件结构

```
Oasis/
├── main_ui.py                 # 图形界面启动文件
├── main_k.py                 # 原始 Kinect 检测脚本
├── ui/                       # UI 模块
│   ├── __init__.py          # 模块初始化
│   ├── main_window.py       # 主窗口类
│   ├── settings_dialog.py   # 设置对话框
│   ├── config.py           # 配置管理
│   └── styles.qss          # 样式表
├── requirements.txt         # 依赖列表
├── yolo11n.pt              # YOLO 模型文件
└── config.json             # 配置文件（自动生成）
```

## 配置文件

系统会自动生成 `config.json` 配置文件，包含以下设置：

- **detection**: 检测相关配置
- **display**: 显示相关配置  
- **kinect**: Kinect 设备配置
- **ui**: 界面布局配置

## 使用技巧

1. **首次运行**: 程序会自动检查依赖项并显示状态
2. **模式选择**: 
   - **有 Kinect 设备**: 选择 "Kinect 2.0 模式"
   - **无 Kinect 设备**: 选择 "调试模式 (电脑摄像头)"
3. **Kinect 视频流**: 在 Kinect 模式下可选择不同视频流类型
   - **彩色图像**: 用于目标检测，推荐日常使用
   - **深度图像**: 查看距离信息，适合深度分析
   - **红外图像**: 低光环境下使用
   - **人体索引**: 人体分割和跟踪
4. **摄像头调试**: 在调试模式下，如果默认摄像头无法使用，尝试切换到摄像头 1 或 2
5. **3D坐标使用**: 
   - 启用3D坐标功能前确保在Kinect彩色模式
   - 检测结果会显示目标的空间坐标信息
   - 坐标精度受Kinect校准质量影响
6. **自定义类别管理**:
   - 添加YOLO支持的任何物体类别名称
   - 类别名称需要与YOLO训练时的名称完全匹配
   - 可随时添加或删除不需要的自定义类别
7. **设备检查**: 在 Kinect 设置页面可以检查设备连接状态
8. **性能优化**: 降低分辨率或减少检测类别可提高性能
9. **快捷键**: 
   - `Ctrl+Q`: 退出应用
   - `Ctrl+,`: 打开设置

## 故障排除

### 快速诊断

```bash
# 运行兼容性测试
python test_pyqt6_compatibility.py

# 运行 UI 系统测试
python test_ui_loader.py
```

### 常见问题

1. **PyQt6 兼容性错误**:
   ```
   AttributeError: 'ApplicationAttribute' has no attribute 'AA_EnableHighDpiScaling'
   ```
   **解决方案**: 使用安全启动器
   ```bash
   python main_ui_safe.py
   ```

2. **配置管理器导入错误**:
   ```
   NameError: name 'config_manager' is not defined
   ```
   **解决方案**: 已修复，重新运行应用即可
   ```bash
   python test_config_fix.py  # 验证修复
   ```

3. **Kinect 未检测到**:
   - 确保已安装 Kinect for Windows SDK 2.0
   - 检查 USB 3.0 连接
   - 确认设备管理器中 Kinect 设备正常

4. **模型加载失败**:
   - 确保 `yolo11n.pt` 文件存在
   - 检查文件路径配置

5. **界面无法启动**:
   - 确认已安装 PyQt6: `pip install --upgrade PyQt6`
   - 检查 Python 版本: `python --version` (需要 >= 3.8)
   - 清理包缓存: `pip cache purge`

6. **UI 文件加载失败**:
   - 检查 ui/ 目录下的 .ui 文件是否完整
   - 确认 ui_loader.py 模块正常工作

7. **调试模式摄像头问题**:
   - 确认电脑摄像头未被其他应用占用
   - 尝试切换不同的摄像头索引 (0, 1, 2)
   - 检查摄像头权限设置
   - 在调试模式下显示的错误信息会指明具体问题

8. **3D坐标功能问题**:
   - 确保在Kinect彩色模式下启用3D坐标功能
   - 检查Kinect深度传感器是否正常工作
   - 3D坐标显示为0或异常值时，检查目标是否在有效深度范围内
   - 坐标精度受环境光照和目标材质影响

9. **自定义类别检测问题**:
   - 确认类别名称与YOLO模型训练时的名称完全匹配
   - 检查是否有特殊字符或拼写错误
   - 部分自定义类别可能需要更高的置信度阈值
   - 删除不需要的自定义类别可提高检测性能

10. **红外模式优化后仍有问题**:
    - 清洁Kinect红外发射器和接收器
    - 确保环境中没有强红外光源干扰
    - 检查Kinect USB连接是否稳定
    - 尝试重启应用程序

11. **窗口缩放界面布局问题**:
    - 现已优化窗口布局，支持自由缩放
    - 控制面板宽度限制在350-450像素
    - 视频区域自适应缩放
    - 分割器比例自动调整

12. **RGB彩色显示问题**:
    - 现已修复Kinect彩色模式偏蓝问题
    - 正确处理BGRA到RGB的颜色转换
    - 区分不同视频流的颜色处理方式
    - 色彩显示更加准确自然

### 性能优化建议

- 使用较小的模型文件 (yolo11n.pt < yolo11s.pt < yolo11m.pt)
- 降低视频分辨率
- 减少同时检测的类别数量
- 调高置信度阈值

## 开发说明

如需修改或扩展功能：

1. **UI 组件**: 修改 `ui/main_window.py`
2. **配置管理**: 修改 `ui/config.py`
3. **样式定制**: 修改 `ui/styles.qss`
4. **设置界面**: 修改 `ui/settings_dialog.py`

## 许可证

© 2024 Oasis Team - 保留所有权利
