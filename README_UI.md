# Oasis 目标检测系统 - PyQt6 图形界面

## 概述

Oasis 是一个基于 Kinect 2.0 和 YOLO 深度学习模型的实时目标检测系统，现已配备现代化的 PyQt6 图形用户界面。

## 主要功能

- 🎯 **实时目标检测**: 使用 YOLO11n 模型进行高效检测
- 📷 **Kinect 2.0 集成**: 支持深度相机实时视频流
- 🐛 **调试模式**: 支持电脑摄像头进行目标检测（无需 Kinect）
- 🎨 **现代化界面**: 基于 PyQt6 的美观用户界面
- ⚙️ **灵活配置**: 可自定义检测类别、置信度等参数
- 📊 **实时统计**: 显示检测结果和性能指标

## 快速开始

### 1. 环境要求

- Python 3.8+
- Kinect for Windows SDK 2.0
- USB 3.0 端口（用于 Kinect 2.0）

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 运行图形界面

```bash
# 推荐：安全启动器（自动处理兼容性问题）
python main_ui_safe.py

# 或者：标准启动器
python main_ui.py

# 或者：UI文件版本启动器
python main_ui_loader.py
```

## 界面功能

### 主窗口组件

1. **视频显示区域**: 实时显示视频流和检测结果
2. **控制面板**: 
   - **检测模式选择**: Kinect 2.0 模式 / 调试模式 (电脑摄像头)
   - **Kinect 视频流选择**: Kinect 模式下可选择视频流类型
   - **摄像头选择**: 调试模式下可选择不同摄像头
   - **开始/停止检测按钮**
   - **目标类别选择器**
3. **检测结果面板**: 显示当前检测到的对象列表
4. **菜单栏**: 
   - 文件 → 设置：打开配置对话框
   - 视图 → 重置布局：恢复默认界面布局
   - 帮助 → 关于：查看版本信息

### 检测模式说明

#### Kinect 2.0 模式
- 使用 Kinect 2.0 深度相机进行检测
- 需要安装 Kinect for Windows SDK 2.0
- 支持多种视频流类型：
  - **彩色图像 (RGB)**: 标准彩色视频，支持目标检测
  - **深度图像**: 距离信息可视化，灰度显示
  - **红外图像**: 红外光谱图像，灰度显示  
  - **人体索引图像**: 人体分割可视化，彩色标识不同人体

#### 调试模式 (电脑摄像头)
- 使用电脑内置或外接摄像头进行检测
- 无需 Kinect 设备，便于开发和测试
- 支持多摄像头选择 (摄像头 0, 1, 2)
- 基于 `main.py` 的功能集成

### 设置对话框

#### 检测设置
- **模型文件**: 选择 YOLO 模型文件
- **置信度阈值**: 调整检测敏感度 (0.01-1.00)
- **最大检测数**: 限制同时检测的对象数量
- **目标类别**: 选择要检测的对象类型

#### 显示设置
- **显示选项**: 控制是否显示置信度和类别名称
- **边框样式**: 调整边界框粗细
- **字体大小**: 设置标签文字大小
- **颜色配置**: 自定义边框和文字颜色

#### Kinect 设置
- **分辨率**: 选择彩色图像分辨率
- **帧率**: 设置视频帧率
- **自动曝光**: 启用/禁用自动曝光控制

## 文件结构

```
Oasis/
├── main_ui.py                 # 图形界面启动文件
├── main_k.py                 # 原始 Kinect 检测脚本
├── ui/                       # UI 模块
│   ├── __init__.py          # 模块初始化
│   ├── main_window.py       # 主窗口类
│   ├── settings_dialog.py   # 设置对话框
│   ├── config.py           # 配置管理
│   └── styles.qss          # 样式表
├── requirements.txt         # 依赖列表
├── yolo11n.pt              # YOLO 模型文件
└── config.json             # 配置文件（自动生成）
```

## 配置文件

系统会自动生成 `config.json` 配置文件，包含以下设置：

- **detection**: 检测相关配置
- **display**: 显示相关配置  
- **kinect**: Kinect 设备配置
- **ui**: 界面布局配置

## 使用技巧

1. **首次运行**: 程序会自动检查依赖项并显示状态
2. **模式选择**: 
   - **有 Kinect 设备**: 选择 "Kinect 2.0 模式"
   - **无 Kinect 设备**: 选择 "调试模式 (电脑摄像头)"
3. **Kinect 视频流**: 在 Kinect 模式下可选择不同视频流类型
   - **彩色图像**: 用于目标检测，推荐日常使用
   - **深度图像**: 查看距离信息，适合深度分析
   - **红外图像**: 低光环境下使用
   - **人体索引**: 人体分割和跟踪
4. **摄像头调试**: 在调试模式下，如果默认摄像头无法使用，尝试切换到摄像头 1 或 2
5. **设备检查**: 在 Kinect 设置页面可以检查设备连接状态
6. **性能优化**: 降低分辨率或减少检测类别可提高性能
7. **自定义类别**: 在设置中选择只检测需要的对象类型
8. **快捷键**: 
   - `Ctrl+Q`: 退出应用
   - `Ctrl+,`: 打开设置

## 故障排除

### 快速诊断

```bash
# 运行兼容性测试
python test_pyqt6_compatibility.py

# 运行 UI 系统测试
python test_ui_loader.py
```

### 常见问题

1. **PyQt6 兼容性错误**:
   ```
   AttributeError: 'ApplicationAttribute' has no attribute 'AA_EnableHighDpiScaling'
   ```
   **解决方案**: 使用安全启动器
   ```bash
   python main_ui_safe.py
   ```

2. **配置管理器导入错误**:
   ```
   NameError: name 'config_manager' is not defined
   ```
   **解决方案**: 已修复，重新运行应用即可
   ```bash
   python test_config_fix.py  # 验证修复
   ```

3. **Kinect 未检测到**:
   - 确保已安装 Kinect for Windows SDK 2.0
   - 检查 USB 3.0 连接
   - 确认设备管理器中 Kinect 设备正常

4. **模型加载失败**:
   - 确保 `yolo11n.pt` 文件存在
   - 检查文件路径配置

5. **界面无法启动**:
   - 确认已安装 PyQt6: `pip install --upgrade PyQt6`
   - 检查 Python 版本: `python --version` (需要 >= 3.8)
   - 清理包缓存: `pip cache purge`

6. **UI 文件加载失败**:
   - 检查 ui/ 目录下的 .ui 文件是否完整
   - 确认 ui_loader.py 模块正常工作

7. **调试模式摄像头问题**:
   - 确认电脑摄像头未被其他应用占用
   - 尝试切换不同的摄像头索引 (0, 1, 2)
   - 检查摄像头权限设置
   - 在调试模式下显示的错误信息会指明具体问题

### 性能优化建议

- 使用较小的模型文件 (yolo11n.pt < yolo11s.pt < yolo11m.pt)
- 降低视频分辨率
- 减少同时检测的类别数量
- 调高置信度阈值

## 开发说明

如需修改或扩展功能：

1. **UI 组件**: 修改 `ui/main_window.py`
2. **配置管理**: 修改 `ui/config.py`
3. **样式定制**: 修改 `ui/styles.qss`
4. **设置界面**: 修改 `ui/settings_dialog.py`

## 许可证

© 2024 Oasis Team - 保留所有权利
